# ADR-002: 評価方式 - Deny優先型の採用

## ステータス
- **日付**: 2025-08-21
- **状態**: 承認
- **決定者**: プロジェクトチーム

## コンテキスト

ACLシステムでは、同一の主体（ユーザーやグループ）に対して複数のエントリー（Allow/Deny）が設定される場合がある。これらの競合する権限設定をどのように評価・解決するかは、システムのセキュリティと使いやすさに大きく影響する。

実際のシステムでは、時系列的な変更、複数管理者による設定、グループと個人の権限競合など、様々な理由で重複設定が発生する。

## 検討したオプション

### オプション1: 順序依存型（Order-Dependent）
エントリーを上から順に評価し、最初にマッチしたエントリーを適用する方式。

- **利点**:
  - より細かい制御が可能
  - 例外ルールを作りやすい
  - Windows NTFS、ファイアウォールACLで採用されている実績

- **欠点**:
  - エントリーの順序管理が複雑
  - ポリシーの合成が困難
  - 管理者が順序を誤ると意図しない結果になる

### オプション2: Deny優先型（Deny-First）
すべてのマッチするエントリーを評価し、1つでもDenyがあれば拒否する方式。

- **利点**:
  - セキュリティ原則に合致（明示的な拒否を優先）
  - エントリーの順序を気にしなくてよい
  - 複数のポリシーソースを容易に統合可能
  - Spring Security、Casbin、AWS IAMで採用されている実績

- **欠点**:
  - 柔軟性がやや低い（Denyが常に優先）
  - すべてのエントリーを評価する必要がある

## 決定

**Deny優先型（オプション2）**を採用する。

セキュリティファーストの原則に従い、明示的な拒否を常に優先することで、より安全なデフォルト動作を実現する。また、実際の認可ライブラリで広く採用されているパターンを学習する観点からも適切である。

### 競合解決のルール

1. すべてのマッチするエントリーを評価（順序に関係なく）
2. 拒否が1つでもあれば拒否
3. 拒否がない場合のみ許可を評価

### AccessDecision型の設計

Deny優先型に合わせたシンプルな3つの状態：
```typescript
type AccessDecision = 
  | { type: 'granted'; allowEntries: Entry[] }
  | { type: 'denied'; denyEntry: Entry; allowEntries: Entry[] }
  | { type: 'no-match' }
```

## 結果

### 利点
- 予測可能で安全なデフォルト動作
- エントリーの順序に依存しない単純な評価ロジック
- デバッグが容易（拒否理由を追跡可能）
- 実際の認可システムの動作を学習できる

### トレードオフ
- 柔軟性の制限（例外的な許可が作りにくい）
- すべてのエントリーを評価するため、エントリー数が多い場合のパフォーマンスへの影響（学習用途では問題なし）

### 今後の課題
- 大規模なエントリーセットでのパフォーマンス最適化
- 同一主体のエントリーを事前に統合する最適化の検討