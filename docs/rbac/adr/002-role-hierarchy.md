# ADR-002: ロール階層 - 階層なしのフラット設計

## ステータス
- **日付**: 2025-08-12
- **状態**: 承認
- **決定者**: プロジェクトチーム

## コンテキスト

多くの実務的なRBACシステムでは、ロール階層（role hierarchy）をサポートしている。階層により、上位ロールが下位ロールの権限を継承できる。学習用実装として、この機能を含めるかどうかを検討する必要がある。

## 業界ライブラリの調査結果

### 完全な階層サポート
- **Spring Security**: `RoleHierarchy`インターフェースによる階層定義
- **Casbin**: ロール継承を`g`ポリシーで定義
- **Keycloak**: 複合ロール（Composite Roles）で階層を実現

### 限定的な階層サポート
- **CASL**: 階層は直接サポートせず、ロール定義時に他のロールを含める
- **node-rbac**: 継承メカニズムあり、ただし単純な実装

### 階層なし
- **Pundit**: フラットなロール構造
- **CanCanCan**: 階層は能力定義で暗黙的に実現
- **accesscontrol**: フラットなロール・権限マッピング

## 検討したオプション

### オプション1: 階層なし（フラット構造）
```typescript
const ROLES = {
  viewer: { permissions: { read: true, write: false } },
  editor: { permissions: { read: true, write: true } },
  admin: { permissions: { read: true, write: true } }
}
```
- 利点：実装がシンプル、理解しやすい、デバッグが容易
- 欠点：権限の重複定義が必要、実際のシステムとの乖離

### オプション2: 単純な階層
```typescript
const ROLES = {
  viewer: { permissions: { read: true } },
  editor: { inherits: ['viewer'], permissions: { write: true } },
  admin: { inherits: ['editor'], permissions: { manage: true } }
}
```
- 利点：基本的な継承を学習可能
- 欠点：実装の複雑さが増す、循環参照の検出が必要

### オプション3: 完全な階層サポート
- 多重継承、動的な階層変更などをサポート
- 利点：実務に近い実装
- 欠点：学習用には過度に複雑

## 決定

**階層なしのフラット構造**を採用する。

### 決定理由

1. **学習効果の最適化**
   - RBACの本質（ロールによる権限の間接管理）に集中できる
   - 階層の複雑さに惑わされることなく、基本概念を理解できる

2. **実装のシンプルさ**
   - 循環参照のチェックが不要
   - 権限評価ロジックが単純明快
   - デバッグとテストが容易

3. **段階的な学習アプローチ**
   - まずフラット構造でRBACの基本を習得
   - 必要に応じて後から階層を追加学習可能

4. **業界のベストプラクティス**
   - 多くの小規模〜中規模システムでは階層なしで十分
   - 階層が必要な場合も、最初はフラット構造から始めることが推奨される

## 結果

### 利点
- **明確な権限定義**: 各ロールの権限が一目で理解できる
- **予測可能な動作**: 継承による予期しない権限付与がない
- **保守性**: 権限の変更影響が限定的で把握しやすい

### トレードオフ
- 権限定義の重複が発生する
- 大規模な組織構造の表現には不向き
- 実際の企業システムとの機能差がある

### 今後の課題
- 階層が必要になった場合の拡張方法の文書化
- フラット構造でも効率的に権限を管理する設計パターンの確立