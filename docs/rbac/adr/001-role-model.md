# ADR-001: ロールモデル - グローバル管理と2層アーキテクチャ

## ステータス
- **日付**: 2025-08-12
- **状態**: 承認
- **決定者**: プロジェクトチーム

## コンテキスト

RBACシステムにおいて、ロールの表現方法と管理スコープは基本設計の中核となる。学習用実装として、型安全性と実装のシンプルさのバランスを考慮する必要がある。

## 検討したオプション

### ロールの表現方法

#### オプション1: 文字列ベース
```typescript
type RoleName = string // "editor", "viewer"
```
- 利点：柔軟性が高い
- 欠点：typoの危険性、型安全性なし

#### オプション2: Enum型
```typescript
enum RoleName {
  VIEWER = 'viewer',
  EDITOR = 'editor',
  ADMIN = 'admin'
}
```
- 利点：型安全
- 欠点：拡張性が低い、値へのアクセスが冗長

#### オプション3: Union型
```typescript
type RoleName = 'viewer' | 'editor' | 'admin'
```
- 利点：型安全、シンプル
- 欠点：ロール定義と型定義が分離

#### オプション4: const assertion + typeof
```typescript
const ROLES = {
  viewer: { name: 'viewer', permissions: {...} },
  editor: { name: 'editor', permissions: {...} },
  admin: { name: 'admin', permissions: {...} }
} as const

type RoleName = keyof typeof ROLES
```
- 利点：型安全、IDE補完、定義の一元化
- 欠点：TypeScript特有の記法

### ロール管理のスコープ

#### オプション1: リソース固有のロール管理
- 各リソースが独自のロールを定義
- 利点：きめ細かい制御が可能
- 欠点：管理が複雑、一貫性の維持が困難

#### オプション2: グローバルロール管理
- 組織全体で一元的にロールを管理
- 利点：一貫性の確保、再利用性が高い
- 欠点：柔軟性に制限がある場合がある

## 決定

**const assertion + typeof によるロール表現**と**グローバルロール管理**を採用し、**2層アーキテクチャ**で実装する。

### 2層アーキテクチャ

1. **第1層: ロール管理（RoleManager）**
   - 組織全体のロール定義
   - ユーザーへのロール割り当て
   - ロールと権限のマッピング管理

2. **第2層: リソース保護（RbacProtectedResource）**
   - 個別リソースの保護
   - RoleManagerを参照して権限評価
   - リソース固有のロジックはここに実装

## 結果

### 利点
- **型安全性**: コンパイル時にロール名の誤りを検出
- **IDE補完**: 開発効率の向上
- **一元管理**: ロール定義の重複を防ぎ、一貫性を保持
- **学習効果**: RBACの本質的な構造（ロールを介した間接的な権限管理）を明確に理解

### トレードオフ
- TypeScript特有の記法を学ぶ必要がある
- リソース固有の例外的な権限設定には追加の仕組みが必要

### 今後の課題
- 動的なロール追加が必要な場合の対応
- マルチテナント環境での実装検討