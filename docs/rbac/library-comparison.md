# RBAC主要ライブラリの比較

## 1. 概要

このドキュメントは、主要なRBACライブラリの特徴と設計判断を比較分析したものである。学習用実装の設計決定の妥当性を裏付けるとともに、実際のプロダクションシステムでの選択肢を理解する。

## 2. ロール階層のサポート状況

### 完全な階層サポート

| ライブラリ | 実装方法 | 特徴 |
|-----------|---------|------|
| **Spring Security** | `RoleHierarchy`インターフェース | 階層定義を文字列で表現（例：`ROLE_ADMIN > ROLE_USER`） |
| **Casbin** | `g`ポリシーによる継承 | ポリシーファイルで階層を定義、多重継承可能 |
| **Keycloak** | Composite Roles | UIまたはAPIで複合ロールを定義、視覚的に管理 |

### 限定的な階層サポート

| ライブラリ | 実装方法 | 制限事項 |
|-----------|---------|----------|
| **CASL** | ロール定義時に他のロールを含める | 明示的な階層メカニズムはない |
| **node-rbac** | 継承メカニズムあり | 単純な実装、循環参照チェックなし |

### 階層なし（フラット構造）

| ライブラリ | 理由 | 代替手段 |
|-----------|------|----------|
| **Pundit** | シンプルさを重視 | ポリシークラスの継承で実現可能 |
| **CanCanCan** | Railsの慣習に従う | 能力定義で暗黙的に実現 |
| **accesscontrol** | 最小限の実装 | 手動でロール権限を重複定義 |

## 3. Deny/否定権限のサポート

### Denyをサポートしない（ポジティブモデル）

| ライブラリ | 設計思想 |
|-----------|----------|
| **Spring Security** | ロールは肯定的な権限のみを表現 |
| **Pundit** | ポリシーは許可のみを定義、否定は暗黙的 |
| **CanCanCan（基本）** | 能力（ability）は基本的に許可を定義 |

### 限定的なDenyサポート

| ライブラリ | 実装方法 | 使用上の注意 |
|-----------|---------|-------------|
| **Casbin** | `deny`ポリシータイプ | 複雑性が増すため推奨されない場合が多い |
| **CASL** | `cannot`メソッド | 使用は推奨されない、例外的なケースのみ |
| **CanCanCan** | `cannot`定義 | 順序依存性があり、管理が複雑になる |

### 明示的なDenyサポート

| ライブラリ/サービス | 実装方法 | 用途 |
|-------------------|---------|------|
| **AWS IAM** | Effect: Deny | ABAC的な使用が主、明示的な拒否が優先 |
| **Azure RBAC** | Deny Assignments | 特殊なケース用、通常は使用しない |
| **Keycloak** | Negative Roles | 複雑で使用は限定的 |

## 4. API設計パターン

### 認可メソッド名

| ライブラリ | メソッド名 | 意味 |
|-----------|-----------|------|
| **Spring Security** | `hasAuthority()`, `hasRole()` | 権限/ロールの所有確認 |
| **Casbin** | `enforce()` | ポリシーの強制実行 |
| **CASL** | `can()` | 能力の確認 |
| **Pundit** | `authorize()` | 認可の実行 |
| **CanCanCan** | `authorize!()`, `can?()` | 認可実行/能力確認 |
| **node-rbac** | `can()` | 権限の確認 |

### ロール管理API

| ライブラリ | 割り当て | 取り消し | 確認 |
|-----------|---------|---------|------|
| **Casbin** | `AddRoleForUser()` | `DeleteRoleForUser()` | `GetRolesForUser()` |
| **node-rbac** | `grant()` | `revoke()` | `hasRole()` |
| **accesscontrol** | `grant()` | `deny()` | `query()` |

## 5. 複数ロールの扱い

### デフォルトで複数ロール対応

| ライブラリ | 権限統合方法 |
|-----------|-------------|
| **Spring Security** | OR演算（いずれかの権限があれば許可） |
| **Casbin** | ポリシーマッチング（最初にマッチしたルール） |
| **Keycloak** | OR演算（全ロールの権限を統合） |
| **CASL** | OR演算（全能力を統合） |

### 単一/複数の選択可能

| ライブラリ | 設定方法 |
|-----------|---------|
| **Pundit** | アプリケーション次第 |
| **CanCanCan** | Railsのユーザーモデル次第 |

## 6. 学習曲線と複雑性

### 初級者向け（学習が容易）

| ライブラリ | 特徴 | 学習時間の目安 |
|-----------|------|---------------|
| **Pundit** | Rubyの慣習に従う、シンプル | 1-2日 |
| **CanCanCan** | DSLが直感的 | 1-2日 |
| **accesscontrol** | 最小限のAPI | 数時間 |

### 中級者向け（バランス型）

| ライブラリ | 特徴 | 学習時間の目安 |
|-----------|------|---------------|
| **CASL** | TypeScript対応、型安全 | 3-5日 |
| **node-rbac** | Node.js向け、適度な機能 | 2-3日 |

### 上級者向け（高機能）

| ライブラリ | 特徴 | 学習時間の目安 |
|-----------|------|---------------|
| **Spring Security** | エンタープライズ機能満載 | 1-2週間 |
| **Casbin** | 多様なモデル対応、高い柔軟性 | 1週間 |
| **Keycloak** | 完全な認証・認可システム | 2-4週間 |

## 7. 実装言語とエコシステム

| ライブラリ | 言語/フレームワーク | エコシステム |
|-----------|-------------------|-------------|
| **Spring Security** | Java/Spring | Spring Boot統合 |
| **Casbin** | Go（多言語対応） | アダプター豊富 |
| **Keycloak** | Java | スタンドアロン/組み込み可能 |
| **CASL** | TypeScript/JavaScript | React/Vue/Angular統合 |
| **Pundit** | Ruby/Rails | Rails標準的選択 |
| **CanCanCan** | Ruby/Rails | Rails深い統合 |
| **node-rbac** | Node.js | Express等と統合 |
| **accesscontrol** | JavaScript | 軽量、依存なし |

## 8. 本実装との比較

### 設計決定の妥当性

| 決定事項 | 本実装 | 業界での採用例 |
|---------|--------|---------------|
| **階層なし** | ✓ | Pundit, CanCanCan, accesscontrol |
| **Denyなし** | ✓ | Spring Security, Pundit（基本） |
| **複数ロール** | ✓ | ほぼ全てのライブラリ |
| **OR演算統合** | ✓ | Spring Security, Keycloak, CASL |
| **`authorize`メソッド** | ✓ | Pundit, 業界標準用語 |

### 学習用実装としての位置づけ

本実装は以下の点で学習に最適化されている：

1. **シンプルさ**: accesscontrol並みのシンプルさ
2. **型安全性**: CASL同様のTypeScript活用
3. **標準的な用語**: Pundit/Spring Security準拠
4. **本質への集中**: 階層やDenyを除外してRBACの核心に集中

## 9. まとめ

主要なRBACライブラリの調査から、以下の知見を得た：

1. **階層サポートは必須ではない**: 多くの実用的なライブラリが階層なしで機能
2. **Denyは複雑性の源**: ほとんどのライブラリがポジティブモデルを採用
3. **複数ロールは標準**: 現代的なRBAC実装では当然の機能
4. **OR演算が一般的**: 権限統合の標準的なアプローチ

本学習用実装の設計は、業界のベストプラクティスに沿っており、RBACの本質を学ぶために適切な判断がなされている。