# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

このリポジトリは、ユーザーが権限管理システムを学習するための実装サンプルを提供します。メモリ内で動作する権限管理システムで、以下の実装パターンを含みます：

- **Linuxベースのパーミッションシステム**: Unix形式の権限管理（rwx形式）
- **ACL (Access Control List)**: より細かい権限制御を実現するアクセス制御リスト
- **RBAC (Role-Based Access Control)**: ロールベースのアクセス制御
- **ABAC (Attribute-Based Access Control)**: 属性ベースのアクセス制御
- **ReBAC (Relationship-Based Access Control)**: 関係性ベースのアクセス制御

### 開発方針

- **学習目的**: このプロジェクトは権限管理を学ぶための教育的なリポジトリです
- **学習の焦点**: 
  - システム全体の模倣ではなく、各権限管理パターンのロジックと特徴の理解に焦点を当てます
  - 各権限管理方式（Linux、ACL、RBAC等）の核心的な仕組みを学ぶことが目的です
  - 実装はシンプルに保ち、権限チェックのアルゴリズムや概念の理解を優先します
- **実装分担**: 
  - プロダクションコードの実装はユーザーが行います
  - テストコードについてはClaudeCodeに実装を依頼する場合があります
- **コード品質**: 学習しやすさを重視し、シンプルで理解しやすい実装を心がけます

## 開発環境

- **ランタイム**: Bun（最新バージョン）
- **言語**: TypeScript
- **ツール管理**: mise

## 主要なコマンド

### 環境セットアップ
```bash
# miseを使用してBunをインストール
mise install
```

### テストの実行
```bash
# 現在テストファイルが空のため、実装後に以下のコマンドで実行
bun test
```

### TypeScriptの型チェック
```bash
bun run typecheck
# または
bunx tsc --noEmit
```

## コードアーキテクチャ

### ディレクトリ構造

```
src/
├── user-based-permission/    # Linuxベースのパーミッションシステム
├── acl/                     # Access Control List実装
├── rbac/                    # Role-Based Access Control実装
├── abac/                    # Attribute-Based Access Control実装
└── rebac/                   # Relationship-Based Access Control実装
```

### 実装済みコンポーネント

#### 1. Linuxベースのパーミッションシステム

**TraditionalPermissions クラス** (`src/user-based-permission/unix-permission.ts`)
- Unix形式の権限管理システムの中心的なクラス
- リソース管理、権限設定、権限チェックの機能を提供

**型定義**
- **Permission**: 読み取り、書き込み、実行の権限を表す
- **UnixPermissions**: 所有者、グループ、その他のユーザーの権限セット
- **UnixResource**: IDを持つリソースで、所有者、グループ、権限情報を含む

**主要メソッド**
- `addResource/removeResource`: リソースの追加・削除
- `chmod/chown/chgrp`: Unix形式の権限・所有者変更
- `checkPermission`: 権限チェックの主要メソッド
- `addUserToGroup/removeUserFromGroup`: グループメンバーシップ管理

### 実装予定のコンポーネント

- **ACL**: 個別のユーザー/グループに対する詳細な権限設定
- **RBAC**: ロールを通じた権限管理
- **ABAC**: 属性（時間、場所、部門等）に基づく動的な権限制御
- **ReBAC**: エンティティ間の関係性に基づく権限制御

## 開発時の注意点

### ClaudeCodeへの指示

- プロダクションコードの実装はユーザーが行うため、実装の提案やアドバイスに留めてください
- テストコードの実装を依頼された場合は、積極的に実装してください
- 各権限管理パターンの概念や違いについて質問された場合は、詳しく説明してください
- **重要**: 設計アドバイスの際は、システム全体の忠実な模倣よりも、各権限管理方式の核心的なロジックの理解を優先してください
- 1インスタンスで1リソースを管理するようなシンプルな設計も、学習目的であれば許容します

### 技術的な注意点

- 現在は型定義とインターフェースのみが実装されており、実装本体は今後追加される予定
- テストファイルは作成されているが、まだテストケースは記述されていない
- Bunのランタイムを使用しているため、Node.js固有のAPIを使用する際は注意が必要
- 各権限管理パターンは独立して実装され、相互に依存しないように設計する

### 設計の考え方

- **シンプルさを優先**: 権限管理のロジックを理解することが主目的のため、過度に複雑な設計は避ける
- **1インスタンス1リソース**: 学習目的では、1つのインスタンスが1つのリソースを管理する設計も許容
- **権限チェックのロジックに集中**: 各権限管理方式の特徴的なアルゴリズムやルールの実装に焦点を当てる

### ADR（Architecture Decision Record）作成方針

各権限管理方式のADRを作成する際は、以下の構成に従ってください：

1. **共通の前提条件**
   - 題材：社内ドキュメント管理システム
   - 権限：read/writeの2種類（実行権限は不要）
   - 認可ライブラリの実装パターンを学ぶ観点を含める

2. **一貫性のある設計判断**
   - 1インスタンス1リソース設計
   - 最小限のAPI（3-5メソッド程度）
   - Tagged Unionによる型安全な結果表現
   - Deny優先型など、実際の認可ライブラリで採用される方式を優先

3. **各権限管理方式の特徴を明確化**
   - 他の方式との違いを明確に説明
   - その方式特有の概念や用語を使用
   - 実装例は最小限かつ本質的なものに絞る

### 権限管理方式の発展と関係

1. **Unix → ACL**: 固定的な3主体から任意数の主体への拡張
2. **ACL → RBAC**: 個別権限設定からロールを介した権限管理へ
3. **RBAC → ABAC**: 静的なロールから動的な属性評価へ
4. **ABAC → ReBAC**: 属性から関係性ベースの権限制御へ

各ADRでは、前の方式からどのように発展したかを明記すること。

### 共通の型定義と設計パターン

すべての権限管理方式で以下を共通化：

- `PermissionBits`: { read: boolean, write: boolean }
- `PermissionAction`: 'read' | 'write'
- アクセスチェックメソッドは各方式に適した名前を使用
  - Unix: `hasPermission`
  - ACL: `checkAccess`
  - RBAC: `checkPermission` または `authorize`
  - ABAC: `evaluate`
  - ReBAC: `checkRelation` または `canAccess`

### 推奨される学習順序

1. **Unixパーミッション**: 基本的な権限概念の理解
2. **ACL**: エントリーリストによる柔軟な権限管理
3. **RBAC**: ロールという抽象化の導入
4. **ABAC**: ルールベースの動的評価
5. **ReBAC**: グラフ構造による関係性表現

各実装は前の実装の理解を前提とせず、独立して学習可能な設計とする。